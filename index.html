async function doParse() {
    const rawInput = document.getElementById('urlInput').value;
    const targetUrl = cleanUrl(rawInput);
    if(!targetUrl) return alert("链接格式不正确");

    const btn = document.getElementById('btnText');
    const loader = document.getElementById('loading');
    
    btn.disabled = true;
    loader.style.display = 'block';

    // 确保使用你的专属 Worker 地址
    const myProxy = `https://qishui-music-tool.luokaikaichina.workers.dev/?url=${encodeURIComponent(targetUrl)}`;

    try {
        const res = await fetch(myProxy);
        const html = await res.text();
        
        console.log("代理响应长度:", html.length); // 诊断日志

        if (html.includes("响应错误") || html.includes("内部错误")) {
            throw new Error(html);
        }

        // 尝试匹配 2026 年可能的多种数据结构
        const matchData = html.match(/_ROUTER_DATA\s*=\s*({[\s\S]*?});/) || 
                          html.match(/window\.__DATA__\s*=\s*({[\s\S]*?});/);
        
        if(!matchData) {
            console.error("完整 HTML 内容以便调试:", html.substring(0, 500));
            throw new Error("页面数据结构已更改，未能找到 _ROUTER_DATA");
        }
        
        const json = JSON.parse(matchData[1]);
        console.log("解析出的 JSON:", json); // 诊断日志

        // 兼容性字段提取
        currentMusic = {
            title: findKey(json, 'trackName') || findKey(json, 'title'),
            artist: findKey(json, 'artistName') || findKey(json, 'authorName'),
            cover: findKey(json, 'coverURL') || findKey(json, 'pic'),
            url: findKey(json, 'url') || findKey(json, 'play_url')
        };

        if(!currentMusic.url) throw new Error("成功拿到数据但音频链接为空");

        document.getElementById('title').innerText = currentMusic.title;
        document.getElementById('artist').innerText = currentMusic.artist;
        document.getElementById('cover').src = currentMusic.cover;
        document.getElementById('player').src = currentMusic.url;
        document.getElementById('result').style.display = 'block';

    } catch (e) {
        console.error("详细解析错误:", e);
        alert("解析失败: " + e.message + "\n请按 F12 查看控制台详细错误。");
    } finally {
        loader.style.display = 'none';
        btn.disabled = false;
    }
}
