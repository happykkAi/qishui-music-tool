<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>汽水音乐解析 - Pro版</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: #fff; text-align: center; padding: 20px; }
        .box { max-width: 400px; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #2c2c2c; color: #fff; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; background: #00ebff; color: #000; font-weight: bold; cursor: pointer; }
        #result { margin-top: 20px; display: none; }
        img { width: 100%; border-radius: 10px; margin-bottom: 10px; }
        audio { width: 100%; margin-top: 10px; }
        .loading { color: #00ebff; display: none; margin: 10px 0; }
    </style>
</head>
<body>

<div class="box">
    <h2>汽水解析下载</h2>
    <input type="text" id="urlInput" placeholder="在此粘贴汽水音乐分享链接">
    <button onclick="doParse()">开始解析</button>
    <div id="loading" class="loading">正在穿透解析中...</div>
    
    <div id="result">
        <img id="cover" src="" alt="cover">
        <h3 id="title"></h3>
        <p id="artist"></p>
        <audio id="player" controls></audio>
        <button style="background: #34c759; margin-top: 10px;" onclick="doDownload()">下载到本地</button>
    </div>
</div>

<script>
    let currentMusic = null;

    async function doParse() {
        const input = document.getElementById('urlInput').value;
        const match = input.match(/https?:\/\/qishui\.douyin\.com\/s\/[a-zA-Z0-9]+\/?/);
        
        if(!match) return alert("请输入正确的汽水音乐分享链接！");

        document.getElementById('loading').style.display = 'block';
        document.getElementById('result').style.display = 'none';

        // 使用代理绕过 CORS
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(match[0])}`;

        try {
            const res = await fetch(proxyUrl);
            if(!res.ok) throw new Error("代理服务器响应失败");
            const html = await res.text();

            // 解析 _ROUTER_DATA
            const matchData = html.match(/_ROUTER_DATA\s*=\s*({[\s\S]*?});/);
            if(!matchData) throw new Error("未能提取到音频数据，可能是链接已失效或解析方案需更新");
            
            const json = JSON.parse(matchData[1]);
            const track = json?.loaderData?.track_page?.audioWithLyricsOption || 
                          json?.loaderData?.['track_page/index']?.audioWithLyricsOption;

            if(!track) throw new Error("解析失败：找不到音频地址");

            currentMusic = {
                title: track.trackName,
                artist: track.artistName,
                cover: track.coverURL,
                url: track.url
            };

            document.getElementById('title').innerText = currentMusic.title;
            document.getElementById('artist').innerText = currentMusic.artist;
            document.getElementById('cover').src = currentMusic.cover;
            document.getElementById('player').src = currentMusic.url;
            document.getElementById('result').style.display = 'block';

        } catch (e) {
            alert("错误: " + e.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function doDownload() {
        if(!currentMusic) return;
        // 注意：部分浏览器可能会因为跨域禁止直接下载，此时会跳转到原链接
        try {
            const a = document.createElement('a');
            a.href = currentMusic.url;
            a.download = `${currentMusic.title}.mp3`;
            a.target = "_blank";
            a.click();
        } catch (e) {
            window.open(currentMusic.url);
        }
    }
</script>
</body>
</html>